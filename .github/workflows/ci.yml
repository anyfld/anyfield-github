name: Main CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  all-status-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - action-lint
      - terraform-lint
      - kics
      # - terraform-plan
    if: ${{ always() }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Check all-status-check
        run: |
          diff \
            <(yq ".jobs | del(.all-status-check) | keys.[]" .github/workflows/ci.yml) \
            <(yq ".jobs.all-status-check.needs.[]" .github/workflows/ci.yml)
      - name: Fail if any needed job failed
        env:
          JOBS: ${{ toJson(needs) }}
        run: |
          for result in $(jq -r '.[].result' <<<"$JOBS"); do
            if [[ ! "$result" =~ ^(success|skipped)$ ]]; then
              exit 1
            fi
          done

  action-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: reviewdog/action-actionlint@83e4ed25b168066ad8f62f5afbb29ebd8641d982 # v1.69.1
        with:
          level: warning

  terraform-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Get Terraform version from mise.toml
        id: terraform-version
        run: |
          if grep -q 'terraform = "latest"' mise.toml; then
            echo "version=latest" >> $GITHUB_OUTPUT
          else
            version=$(grep 'terraform = ' mise.toml | sed 's/.*terraform = "\(.*\)".*/\1/')
            echo "version=$version" >> $GITHUB_OUTPUT
          fi
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ steps.terraform-version.outputs.version }}
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33 # v6.2.1
        with:
          tflint_version: latest
      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive
      - name: TFLint
        run: |
          cd terraform
          tflint

  kics:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: checkmarx/kics-github-action@e01759d524f8abd5bd650d3d5bd4b96d46ebbc1d # v2.1.17
        with:
          path: terraform

  # terraform-plan:
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 10
  #   if: github.event_name == 'pull_request'
  #   permissions:
  #     contents: read
  #     pull-requests: write
  #     id-token: write
  #     actions: write
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
  #     - name: Authenticate to Google Cloud
  #       uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
  #       with:
  #         workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
  #         service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
  #     - name: Get Terraform version from mise.toml
  #       id: terraform-version
  #       run: |
  #         if grep -q 'terraform = "latest"' mise.toml; then
  #           echo "version=latest" >> $GITHUB_OUTPUT
  #         else
  #           version=$(grep 'terraform = ' mise.toml | sed 's/.*terraform = "\(.*\)".*/\1/')
  #           echo "version=$version" >> $GITHUB_OUTPUT
  #         fi
  #     - name: Setup Terraform
  #       uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
  #       with:
  #         terraform_version: ${{ steps.terraform-version.outputs.version }}
  #     - name: Terraform Init
  #       run: |
  #         cd terraform
  #         terraform init
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #     - name: Terraform Plan
  #       id: plan
  #       run: |
  #         cd terraform
  #         terraform plan -no-color -out=tfplan > plan_output.txt 2>&1 || true
  #         terraform show -no-color tfplan >> plan_output.txt 2>&1 || true
  #       continue-on-error: true
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #     - name: Prepare comment message
  #       run: |
  #         cd terraform
  #         {
  #           echo "<details>"
  #           echo "<summary><b>Terraform Plan Results</b></summary>"
  #           echo ""
  #           echo '```'
  #           cat plan_output.txt
  #           echo '```'
  #           echo "</details>"
  #         } > comment_message.txt
  #     - name: Comment PR
  #       uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # v2.8.2
  #       with:
  #         message-path: terraform/comment_message.txt
  #         message-id: terraform-plan
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
